<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
    <title>New Test</title>
  </head>

  <body>
    <table cellpadding="1" cellspacing="1" border="1">
      <thead>
        <tr>
          <td rowspan="1" colspan="3">New Test</td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>loadConfigFileAndWait</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>storeParams</td>
          <td>inst branch admin_user_login admin_user_passwd unprivileged_user_login</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><b>gotoIf</b></td>
          <td>storedVars["branch"] == 220</td>
          <td>not_for_220</td>
        </tr>
        <tr>
          <td>open</td>
          <td>${inst}relogin.cgi</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Logged Out</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>open</td>
          <td>${inst}editparams.cgi?section=groupsecurity</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Log in to Bugzilla</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>type</td>
          <td>Bugzilla_login</td>
          <td>${admin_user_login}</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>Bugzilla_login</td>
          <td>${admin_user_login}</td>
        </tr>
      <tr>
        <td>type</td>
        <td>Bugzilla_password</td>
        <td>${admin_user_passwd}</td>
      </tr>
      <tr>
        <td>verifyValue</td>
        <td>Bugzilla_password</td>
        <td>${admin_user_passwd}</td>
      </tr>
      <tr>
        <td>clickAndWait</td>
        <td>//input[@type='submit' and @value='Log in']</td>
        <td>&nbsp;</td>
      </tr>
        <!-- Go and turn on 'usevisibilitygroups' -->
        <tr>
          <td>assertTitle</td>
          <td>Bugzilla Configuration: Group Security</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>click</td>
          <td>//input[@name='usevisibilitygroups' and @value='1']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@type='submit' and @value='Save Changes']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Parameters Updated</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>link=Users</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Search users</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>type</td>
          <td>matchstr</td>
          <td>${unprivileged_user_login}</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>matchstr</td>
          <td>${unprivileged_user_login}</td>
        </tr>
        <tr>
          <td>select</td>
          <td>matchtype</td>
          <td>value=exact</td>
        </tr>
        <tr>
          <td>verifySelected</td>
          <td>matchtype</td>
          <td>value=exact</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@value='Search']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Edit user ${unprivileged_user_login}</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>login</td>
          <td>${unprivileged_user_login}</td>
        </tr>
        <!-- First, use the normal way to impersonate a user -->
        <tr>
          <td>clickAndWait</td>
          <td>link=Impersonate this user</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Begin sudo session</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>target_login</td>
          <td>${unprivileged_user_login}</td>
        </tr>
        <tr>
          <td>type</td>
          <td>reason</td>
          <td>Selenium test about sudo sessions</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>reason</td>
          <td>Selenium test about sudo sessions</td>
        </tr>
        <tr>
          <td>type</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@value='Begin Session']</td>
          <td>&nbsp;</td>
        </tr>
        <!-- The user is in no group, and so is invisible while 'usevisibilitygroups' is on -->
        <tr>
          <td>assertTitle</td>
          <td>Match Failed</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyFlatTextPresent</td>
          <td>${unprivileged_user_login} does not exist or you are not allowed to see that user</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Turn off 'usevisibilitygroups' -->
        <tr>
          <td>open</td>
          <td>${inst}editparams.cgi?section=groupsecurity</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Bugzilla Configuration: Group Security</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>click</td>
          <td>//input[@name='usevisibilitygroups' and @value='0']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@type='submit' and @value='Save Changes']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Parameters Updated</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Now try to impersonate the same user again -->
        <tr>
          <td>open</td>
          <td>${inst}relogin.cgi?action=prepare-sudo&amp;target_login=${unprivileged_user_login}</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Begin sudo session</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>target_login</td>
          <td>${unprivileged_user_login}</td>
        </tr>
        <tr>
          <td>type</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@value='Begin Session']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Sudo session started</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyFlatTextPresent</td>
          <td>The sudo session has been started</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>link=Prefs</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>User Preferences</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>link=Permissions</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>User Preferences</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Make sure this user is not an admin and has no privs at all -->
        <tr>
          <td>verifyFlatTextPresent</td>
          <td>There are no permission bits set on your account</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Make sure I cannot access editusers.cgi -->
        <tr>
          <td>open</td>
          <td>${inst}editusers.cgi</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Authorization Required</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertFlatTextPresent</td>
          <td>Sorry, you aren't a member of the 'editusers' group</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>link=end session</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Sudo session complete</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertFlatTextPresent</td>
          <td>The sudo session has been ended</td>
          <td>&nbsp;</td>
        </tr>
        <!-- As an admin, try to begin a sudo session directly, without providing credentials -->
        <tr>
          <td>open</td>
          <td>${inst}relogin.cgi?action=begin-sudo</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Password Required</td>
          <td>&nbsp;</td>
        </tr>
        <!-- As an admin, try to begin a sudo session directly, by providing correct credentials -->
        <tr>
          <td>open</td>
          <td>${inst}relogin.cgi?action=begin-sudo&amp;Bugzilla_login=${admin_user_login}&amp;Bugzilla_password=${admin_user_passwd}&amp;target_login=${admin_user_login}</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Preparation Required</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>link=start your session normally</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Try to impersonate an administrator -->
        <tr>
          <td>assertTitle</td>
          <td>Begin sudo session</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>target_login</td>
          <td>${admin_user_login}</td>
        </tr>
        <tr>
          <td>type</td>
          <td>reason</td>
          <td>Selenium hack</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>reason</td>
          <td>Selenium hack</td>
        </tr>
        <tr>
          <td>type</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@value='Begin Session']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>User Protected</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyFlatTextPresent</td>
          <td>The user ${admin_user_login} may not be impersonated by sudoers</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>goBackAndWait</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Now try to impersonate a non-existing user, without providing the password -->
        <tr>
          <td>assertTitle</td>
          <td>Begin sudo session</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>type</td>
          <td>target_login</td>
          <td>foo@bar.com</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>target_login</td>
          <td>foo@bar.com</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@value='Begin Session']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Invalid Username Or Password</td>
          <td>&nbsp;</td>
        </tr>
        <!-- Now try to impersonate an existing user, by providing the password -->
        <tr>
          <td>open</td>
          <td>${inst}relogin.cgi?action=prepare-sudo&amp;target_login=foo@bar.com</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Begin sudo session</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>target_login</td>
          <td>foo@bar.com</td>
        </tr>
        <tr>
          <td>type</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>verifyValue</td>
          <td>Bugzilla_password</td>
          <td>${admin_user_passwd}</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>//input[@value='Begin Session']</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Match Failed</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>verifyFlatTextPresent</td>
          <td>foo@bar.com does not exist or you are not allowed to see that user</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>clickAndWait</td>
          <td>link=Log out</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>assertTitle</td>
          <td>Logged Out</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><b>label</b></td>
          <td>not_for_220</td>
          <td>&nbsp;</td>
        </tr>
      </tbody>
    </table>
  </body>
</html>
